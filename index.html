<!DOCTYPE html>
<html>
<head>
	<meta charset = utf-8>
	<title>Chill Vibes</title>
	<style>
		* {
			margin: 0px;
			padding: 0px;
			box-sizing: border-box;
			font-family: 'Calibri';
		}
		body {
			white-space: pre;
			color: #fefefe;
			background-color: #222b28;
			width: 100vw;
			height: 100vh;
		}
		/* first left:__; spacings for original img, top-left to bottom-right flow */
		/* second left:__; spacings for flipped img, centered top to bottom flow */
		.welcome-text {
			position: absolute;
			top: 4vw;
			left: 12vw;
/*			left: 28vw;*/
			font-size: 6vw;
			filter: drop-shadow(0 0 1px #444);
		}
		.selection-text {
			position: absolute;
			top: 27vw;
			left: 24vw;
/*			left: 27vw;*/
			font-size: 2.5vw;
			filter: drop-shadow(0 0 1px #444);
		}
		.selection-box {
			border-bottom: 2px solid #fefefe;

			position: absolute;
			padding: 0 1vw;
			top: 27.5vw;
			left: 53vw;
/*			left: 56vw;*/
			font-size: 2vw;
			filter: drop-shadow(0 0 1px #444);
		}
	</style>
</head>
<body>

<script type="text/javascript" src="images/resources.js"></script>
<script type="text/javascript" src="music/resources.js"></script>

<script type="text/javascript">

	class AudioPlayer {
		constructor (tracklist) {
			this.player = document.createElement('audio');
			this.repeat = false;
			this.nowPlaying = 0;
			this.tracklist = tracklist.map(x => x);
			this.shuffleOrder = [];

			// this.seekBar = document.createElement()

			// autoplay
			this.player.addEventListener('ended', () => {
				if (!this.repeat)
					this.next();
				this.player.currentTime = 0;
				this.play().update();
			});
		}
		get paused () { return this.player.paused; }
		get shuffled () { return this.shuffleOrder.length != 0; }
		get repeating () { return this.player.loop; }
		get currentTrack () { return this.tracklist[ this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying ]; }
		get currentTime () { return this.player.currentTime; }
		get duration () { return this.player.duration; }
		setSrc (src) {
			this.player.pause();
			this.player.src = 'music/' + src;
			return this;
		}
		play () {
			if (this.player.currentSrc == '') {
				const track = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
				this.setSrc(this.tracklist[track].path);
			}
			this.player.play();
			return this;
		}
		pause () {
			this.player.pause();
			return this;
		}
		next () {
			const wasPaused = this.paused;
			this.nowPlaying = (this.nowPlaying + 1) % this.tracklist.length;
			const track = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
			this.setSrc(this.tracklist[track].path);
			if (!wasPaused) this.play();
			return this;
		}
		prev () {
			const wasPaused = this.paused;
			this.nowPlaying = (this.nowPlaying - 1 + this.tracklist.length) % this.tracklist.length;
			const track = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
			this.setSrc(this.tracklist[track].path);
			if (!wasPaused) this.play();
			return this;
		}
		shuffle () {
			const lastTrack = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
			this.shuffleOrder = this.tracklist.map( (x,i) => i );
			// Durstenfeld shuffle in O(n)
			for (let i = this.shuffleOrder.length - 1; i > 0; i--) {
				const j = Math.floor(Math.random() * (i + 1));
				[this.shuffleOrder[i], this.shuffleOrder[j]] = [this.shuffleOrder[j], this.shuffleOrder[i]];
			}
			this.nowPlaying = this.shuffleOrder.indexOf(lastTrack);
			return this;
		}
		unshuffle () {
			this.nowPlaying = this.shuffleOrder[this.nowPlaying];
			this.shuffleOrder = [];
			return this;
		}

		get timeStr () {
			const currentSeconds = Math.floor(this.currentTime % 60);
			const currentMinutes = Math.floor((this.currentTime-currentSeconds) / 60);
			return String(currentMinutes).padStart(2,'0') + ':' + String(currentSeconds).padStart(2,'0');
		}
		get durationStr () {
			if (!this.duration) return '00:00';
			const durationSeconds = Math.floor(this.duration % 60);
			const durationMinutes = Math.floor((this.duration-durationSeconds) / 60);
			return String(durationMinutes).padStart(2,'0') + ':' + String(durationSeconds).padStart(2,'0');
		}
		get domStr () {
			let s = '';

			s += '[k] play/pause\n';
			s += '[j] prev\n';
			s += '[l] next\n';
			s += '[m] mute\n';
			s += '[r] repeat current track\n';
			s += '[s] shuffle tracks\n';
			s += '[Shift]+[s] turn off shuffle\n';
			s += '\n';

			s += this.paused ? 'PAUSED' : 'PLAYING';
			s += this.player.muted ? ', MUTED' : '';
			s += this.repeat ? ', REPEAT CURRENT' : '';
			s += '\n\n';

			const seek = 'musicPlayer.player.fastSeek(document.getElementById("timeSlider").value/100 * musicPlayer.duration)';
			s += `<input type = 'range' min = '0' max = '100' value = '0' step = '0.01' class = 'slider' id = 'timeSlider' oninput = '` + seek + `'>  `;
			s += this.timeStr + ' / ' + this.durationStr;
			s += '\n\n';

			for (let i = 0; i < this.tracklist.length; i++) {
				const track = this.shuffled ? this.shuffleOrder[i] : i;
				s += (i == this.nowPlaying) ? '>>' : '  ';
				s += ' ' + String(track+1).padStart(2,'0');
				s += ' ' + this.tracklist[track].composer + ' - ' + this.tracklist[track].title;
				s += '\n';
			}

			return s;
		}
		update () {
			document.body.innerHTML = this.domStr;
		}
	}

	///////////////////

	function loadWelcomeScreen (bgImgId = 0) {
		document.body.innerHTML = '';

		document.body.style.background = 'url("images/' + imageResources[bgImgId].path + '") no-repeat center center fixed';
		document.body.style.backgroundSize = 'cover';

		let welcomeText = document.createElement('div');
		welcomeText.classList.add('welcome-text');
		welcomeText.innerHTML = 'Hello, there.\n   Ready to Chill?';
		document.body.appendChild(welcomeText);

		let selectionText = document.createElement('div');
		selectionText.classList.add('selection-text');
		selectionText.innerHTML = 'Pick a soundscape to begin:';
		document.body.appendChild(selectionText);

		let selectionBox = document.createElement('div');
		selectionBox.classList.add('selection-box');
		selectionBox.innerHTML = 'Cozy Campfire';
		document.body.appendChild(selectionBox);
	}

	function updateBackground (e) {
		const maxOffset = 20;
		// responsive scale
		const minWidth = window.innerWidth + maxOffset;
		const minHeight = window.innerHeight + maxOffset;
		document.body.style.backgroundSize = (window.innerWidth > window.innerHeight) ? minWidth+'px auto' : 'auto '+minHeight+'px';
		// parallax effect
		const dx = -maxOffset * e.clientX/window.innerWidth;
		const dy = -maxOffset * e.clientY/window.innerHeight;
		document.body.style.backgroundPosition = dx + 'px ' + dy + 'px';
	}

	document.body.addEventListener('mousemove', updateBackground);
	document.body.addEventListener('resize', updateBackground);

	//////////////////

	document.body.addEventListener('keydown', e => {
		switch (e.key) {
		case 'k': // play/pause
			musicPlayer.paused ? musicPlayer.play().update() : musicPlayer.pause().update();
			break;
		case 'j': musicPlayer.prev().update(); break; // prev
		case 'l': musicPlayer.next().update(); break; // next
		case 'm': musicPlayer.player.muted = !musicPlayer.player.muted; musicPlayer.update(); break; // toggle mute
		case 'r': musicPlayer.repeat = !musicPlayer.repeat; musicPlayer.update(); break; // toggle repeat
		case 's': musicPlayer.shuffle().update(); break; // shuffle
		case 'S': musicPlayer.unshuffle().update(); break; // unshuffle
		}
	});

	function animate () {
		musicPlayer.update();
		document.getElementById('timeSlider').value = (100 * musicPlayer.currentTime/musicPlayer.duration) || 0;
		requestAnimationFrame(animate);
	}
	
	// let musicPlayer = new AudioPlayer(musicResources);
	loadWelcomeScreen(0);
	// animate();

</script>

</body>
</html>