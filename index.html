<!DOCTYPE html>
<html>
<head>
	<meta charset = utf-8>
	<title>Chill Vibes</title>
	<style>
		* {
			margin: 0px;
			padding: 0px;
			box-sizing: border-box;
		}
		body {
			white-space: pre;
		}
	</style>
</head>
<body>

<script type="text/javascript" src="music/resources.js"></script>

<script type="text/javascript">

	class AudioPlayer {
		constructor (tracklist) {
			this.player = document.createElement('audio');
			this.nowPlaying = 0;
			this.tracklist = tracklist.map(x => x);
			this.shuffleOrder = [];
		}
		get shuffled () { return this.shuffleOrder.length != 0; }
		get currentTrack () { return this.tracklist[ this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying ]; }
		get paused () { return this.player.paused; }
		setSrc (src) {
			this.player.pause();
			this.player.src = 'music/' + src;
			return this;
		}
		play () {
			if (this.player.currentSrc == '') {
				const track = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
				this.setSrc(this.tracklist[track].path);
			}
			this.player.play();
			return this;
		}
		pause () {
			this.player.pause();
			return this;
		}
		next () {
			const wasPaused = this.paused;
			this.nowPlaying = (this.nowPlaying + 1) % this.tracklist.length;
			const track = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
			this.setSrc(this.tracklist[track].path);
			if (!wasPaused) this.play();
			return this;
		}
		prev () {
			const wasPaused = this.paused;
			this.nowPlaying = (this.nowPlaying - 1 + this.tracklist.length) % this.tracklist.length;
			const track = this.shuffled ? this.shuffleOrder[this.nowPlaying] : this.nowPlaying;
			this.setSrc(this.tracklist[track].path);
			if (!wasPaused) this.play();
			return this;
		}
		shuffle () {
			this.shuffleOrder = this.tracklist.map( (x,i) => i );
			// Durstenfeld shuffle in O(n)
			for (let i = this.shuffleOrder.length - 1; i > 0; i--) {
				const j = Math.floor(Math.random() * (i + 1));
				[this.shuffleOrder[i], this.shuffleOrder[j]] = [this.shuffleOrder[j], this.shuffleOrder[i]];
			}
			return this;
		}
		unshuffle () {
			this.nowPlaying = this.shuffleOrder[this.nowPlaying];
			this.shuffleOrder = [];
			return this;
		}

		get domStr () {
			let s = '';

			s += '[k] play/pause\n[j] prev\n[l] next\n\n';
			s += this.paused ? 'PAUSED\n\n' : 'PLAYING\n\n';

			for (let i = 0; i < this.tracklist.length; i++) {
				const track = this.shuffled ? this.shuffleOrder[i] : i;
				s += (i == this.nowPlaying) ? '>>' : '  ';
				s += ' ' + track;
				s += ' ' + this.tracklist[track].composer + ' - ' + this.tracklist[track].title;
				s += '\n';
			}

			return s;
		}
		update () {
			document.body.innerHTML = this.domStr;
		}
	}

	document.body.addEventListener('keydown', e => {
		switch (e.key) {
		case 'k': // play/pause
			musicPlayer.paused ? musicPlayer.play().update() : musicPlayer.pause().update();
			break;
		case 'j': musicPlayer.prev().update(); break; // prev
		case 'l': musicPlayer.next().update(); break; // next
		}
	});
	
	let musicPlayer = new AudioPlayer(resources);

	musicPlayer.update();

</script>

</body>
</html>